#!/bin/sh

#set -eu

echo "start timelapse shell"

#while true;
while [ `date "+%H"` -ge 5 ];
do
	NOW_DATE=`date "+%Y-%m-%d"`
	NOW_HOUR=`date "+%H"`
	NOW_MIN=`date "+%M"`
	NOW_SEC=`date "+%S"`
	echo `/bin/date "+%Y-%m-%d %H:%M:%S"` ": Start taking photo" && 
	mkdir -p /media/seiichi/laundry_monitoring_service/photos/${NOW_DATE}/${NOW_HOUR} &&
	raspistill -o /media/seiichi/laundry_monitoring_service/photos/${NOW_DATE}/${NOW_HOUR}/${NOW_MIN}-${NOW_SEC}.jpeg -w 320 -h 240 -q 10 &&
	echo `/bin/date "+%Y-%m-%d %H:%M:%S"` ": Done taking photo" && 
#	sleep 3 &&
	echo `/bin/date "+%Y-%m-%d %H:%M:%S"` ": Start gzip photo" && 
	/bin/gzip /media/seiichi/laundry_monitoring_service/photos/${NOW_DATE}/${NOW_HOUR}/${NOW_MIN}-${NOW_SEC}.jpeg &&
	echo `/bin/date "+%Y-%m-%d %H:%M:%S"` ": Done gzip photo" && 
#	sleep 3 &&
	echo `/bin/date "+%Y-%m-%d %H:%M:%S"` ": Start uploading photo" &&
#	/usr/local/bin/aws s3api put-object --bucket laundry-monitoring-service-storage-prod --key photos/${NOW_DATE}/${NOW_HOUR}/${NOW_MIN}-${NOW_SEC}.jpeg.gz --body /media/seiichi/laundry_monitoring_service/photos/${NOW_DATE}/${NOW_HOUR}/${NOW_MIN}-${NOW_SEC}.jpeg.gz --acl public-read --content-encoding "gzip" --endpoint-url https://laundry-monitoring-service-storage-prod.s3-accelerate.amazonaws.com &&
#	/usr/local/bin/aws s3api put-object --bucket laundry-monitoring-service-storage-prod --key photos/${NOW_DATE}/${NOW_HOUR}/${NOW_MIN}-${NOW_SEC}.jpeg.gz --body /media/seiichi/laundry_monitoring_service/photos/${NOW_DATE}/${NOW_HOUR}/${NOW_MIN}-${NOW_SEC}.jpeg.gz --acl public-read --content-encoding "gzip" &&
	/usr/local/bin/aws s3 cp /media/seiichi/laundry_monitoring_service/photos/${NOW_DATE}/${NOW_HOUR}/${NOW_MIN}-${NOW_SEC}.jpeg.gz s3://laundry-monitoring-service-storage-prod/photos/${NOW_DATE}/${NOW_HOUR}/${NOW_MIN}-${NOW_SEC}.jpeg.gz --acl public-read --content-encoding "gzip" --region ap-northeast-1 --endpoint-url http://s3-accelerate.amazonaws.com &&
#	/usr/local/bin/aws s3 sync /media/seiichi/laundry_monitoring_service/photos/${NOW_DATE}/${NOW_HOUR} s3://laundry-monitoring-service-storage-prod/photos/${NOW_DATE}/${NOW_HOUR} --acl public-read --content-encoding "gzip" &&
	echo `/bin/date "+%Y-%m-%d %H:%M:%S"` ": Done uploading photo" 
done

